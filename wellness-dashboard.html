<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Bienestar Personal</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Principios HIG: Tipograf√≠a clara y escalada */
        body {
            font-size: 16px; /* Base m√≠nimo HIG */
            line-height: 1.4;
        }

        /* Touch targets m√≠nimo 44px (HIG) */
        button, input[type="checkbox"], .clickable {
            min-height: 44px;
            min-width: 44px;
        }

        /* Focus visible (HIG Accesibilidad) */
        button:focus-visible, input:focus-visible {
            outline: 2px solid #2196F3;
            outline-offset: 2px;
        }

        /* Transiciones suaves (HIG) */
        * {
            transition: all 0.2s ease;
        }

        /* Grid de 8px spacing (HIG) */
        .gap-hig-sm { gap: 8px; }
        .gap-hig-md { gap: 12px; }
        .gap-hig-lg { gap: 16px; }
        .gap-hig-xl { gap: 24px; }

        /* Contraste adecuado (HIG) */
        .text-primary { color: #212121; }
        .text-secondary { color: #757575; }
    </style>
</head>
<body class="bg-gray-50 text-primary">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ============================================
        // SUPABASE INITIALIZATION
        // ============================================

        const SUPABASE_URL = 'https://xladlmxuojiutwmddlpe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsYWRsbXh1b2ppdXR3bWRkbHBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxOTMyNzgsImV4cCI6MjA3Nzc2OTI3OH0.sn7Qxi1JbGlG1XVQChRmtr3WEiCrw69VRhWA3m914BE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // CUSTOM HOOKS
        // ============================================

        // Hook para localStorage con auto-guardado
        function useLocalStorage(key, initialValue) {
            const [value, setValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                    return initialValue;
                }
            });

            useEffect(() => {
                try {
                    window.localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error('Error saving to localStorage:', error);
                }
            }, [key, value]);

            return [value, setValue];
        }

        // Hook para Supabase con sincronizaci√≥n en la nube
        function useSupabase(tableName, initialValue, userId) {
            const [value, setValue] = useState(initialValue);
            const [loading, setLoading] = useState(true);

            // Cargar datos al montar
            useEffect(() => {
                if (!userId) {
                    setLoading(false);
                    return;
                }

                loadFromSupabase();
            }, [userId, tableName]);

            const loadFromSupabase = async () => {
                try {
                    if (tableName === 'wellness_currentWeek') {
                        const { data, error } = await supabase
                            .from('wellness_weeks')
                            .select('*')
                            .eq('user_id', userId)
                            .is('archived_date', null)
                            .order('created_at', { ascending: false })
                            .limit(1)
                            .single();

                        if (error && error.code !== 'PGRST116') {
                            console.error('Error loading current week:', error);
                        }
                        if (data) {
                            setValue(dbToAppFormat(data));
                        }
                    } else if (tableName === 'wellness_historical') {
                        const { data, error } = await supabase
                            .from('wellness_weeks')
                            .select('*')
                            .eq('user_id', userId)
                            .not('archived_date', 'is', null)
                            .order('year', { ascending: false })
                            .order('week_number', { ascending: false });

                        if (error) {
                            console.error('Error loading historical:', error);
                        }
                        if (data) {
                            setValue(data.map(dbToAppFormat));
                        }
                    } else if (tableName === 'wellness_config') {
                        const { data, error } = await supabase
                            .from('wellness_config')
                            .select('*')
                            .eq('user_id', userId)
                            .single();

                        if (error && error.code !== 'PGRST116') {
                            console.error('Error loading config:', error);
                        }
                        if (data) {
                            setValue({ nombre: data.nombre, estatura: data.estatura });
                        }
                    }
                } finally {
                    setLoading(false);
                }
            };

            // Guardar a Supabase cuando value cambia
            useEffect(() => {
                if (!userId || loading) return;

                const saveToSupabase = async () => {
                    try {
                        if (tableName === 'wellness_currentWeek') {
                            const dbData = appToDbFormat(value, userId);
                            const { error } = await supabase
                                .from('wellness_weeks')
                                .upsert(dbData, {
                                    onConflict: 'user_id,week_number,year'
                                });

                            if (error) console.error('Error saving week:', error);
                        } else if (tableName === 'wellness_config') {
                            const { error } = await supabase
                                .from('wellness_config')
                                .upsert({
                                    user_id: userId,
                                    ...value,
                                    updated_at: new Date().toISOString()
                                }, {
                                    onConflict: 'user_id'
                                });

                            if (error) console.error('Error saving config:', error);
                        }
                    } catch (error) {
                        console.error('Save error:', error);
                    }
                };

                const timer = setTimeout(saveToSupabase, 1000);
                return () => clearTimeout(timer);
            }, [value, userId, tableName, loading]);

            return [value, setValue, loading];
        }

        // ============================================
        // UTILIDADES
        // ============================================

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function calculateBMI(weight, height) {
            if (!weight || !height) return null;
            const heightM = height / 100;
            return (weight / (heightM * heightM)).toFixed(1);
        }

        function getBMICategory(bmi) {
            if (!bmi) return '';
            if (bmi < 18.5) return 'Bajo peso';
            if (bmi < 25) return 'Normal';
            if (bmi < 30) return 'Sobrepeso';
            if (bmi < 35) return 'Obesidad I';
            if (bmi < 40) return 'Obesidad II';
            return 'Obesidad III';
        }

        function calculateFoodQuality(weekData) {
            let totalPoints = 0;
            let totalMeals = 0;

            const days = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            days.forEach(day => {
                ['desayuno', 'almuerzo', 'cena'].forEach(meal => {
                    const quality = weekData[day][meal];
                    if (quality !== 'pendiente') {
                        totalMeals++;
                        if (quality === 'bueno') totalPoints += 3;
                        else if (quality === 'regular') totalPoints += 2;
                        else if (quality === 'malo') totalPoints += 1;
                    }
                });
            });

            if (totalMeals === 0) return 0;
            return Math.round((totalPoints / (totalMeals * 3)) * 100);
        }

        function getFoodQualityMessage(percentage) {
            if (percentage >= 85) return { text: '¬°Excelente calidad!', emoji: 'üåü', color: 'text-green-600' };
            if (percentage >= 70) return { text: 'Muy buena semana', emoji: 'üí™', color: 'text-blue-600' };
            if (percentage >= 55) return { text: 'Bien, puedes mejorar', emoji: 'üëç', color: 'text-yellow-600' };
            return { text: 'Enf√≥cate en calidad', emoji: '‚ö†Ô∏è', color: 'text-orange-600' };
        }

        function getInitialDayData(type) {
            return {
                tipo: type,
                ejercicio: false,
                movimiento: false,
                pausa1: false,
                pausa2: false,
                aireLibre: false,
                familia: false,
                sueno: false,
                mealPrep: false,
                prep: false,
                desayuno: 'pendiente',
                almuerzo: 'pendiente',
                cena: 'pendiente',
                vasos: 0
            };
        }

        function getInitialWeekData() {
            const today = new Date();
            return {
                weekNumber: getWeekNumber(today),
                year: today.getFullYear(),
                startDate: today.toISOString(),
                peso: '',
                cintura: '',
                estatura: '',
                lunes: getInitialDayData('natacion'),
                martes: getInitialDayData('fuerza'),
                miercoles: getInitialDayData('descanso'),
                jueves: getInitialDayData('natacion'),
                viernes: getInitialDayData('fuerza'),
                sabado: getInitialDayData('finDeSemana'),
                domingo: getInitialDayData('finDeSemana')
            };
        }

        // Convertir formato DB a formato App
        function dbToAppFormat(dbWeek) {
            return {
                weekNumber: dbWeek.week_number,
                year: dbWeek.year,
                startDate: dbWeek.start_date,
                peso: dbWeek.peso || '',
                cintura: dbWeek.cintura || '',
                estatura: dbWeek.estatura || '',
                lunes: dbWeek.lunes || getInitialDayData('natacion'),
                martes: dbWeek.martes || getInitialDayData('fuerza'),
                miercoles: dbWeek.miercoles || getInitialDayData('descanso'),
                jueves: dbWeek.jueves || getInitialDayData('natacion'),
                viernes: dbWeek.viernes || getInitialDayData('fuerza'),
                sabado: dbWeek.sabado || getInitialDayData('finDeSemana'),
                domingo: dbWeek.domingo || getInitialDayData('finDeSemana'),
                archivedDate: dbWeek.archived_date
            };
        }

        // Convertir formato App a formato DB
        function appToDbFormat(appWeek, userId) {
            return {
                user_id: userId,
                week_number: appWeek.weekNumber,
                year: appWeek.year,
                start_date: appWeek.startDate,
                peso: appWeek.peso || null,
                cintura: appWeek.cintura || null,
                estatura: appWeek.estatura || null,
                lunes: appWeek.lunes,
                martes: appWeek.martes,
                miercoles: appWeek.miercoles,
                jueves: appWeek.jueves,
                viernes: appWeek.viernes,
                sabado: appWeek.sabado,
                domingo: appWeek.domingo,
                archived_date: appWeek.archivedDate || null,
                updated_at: new Date().toISOString()
            };
        }

        // ============================================
        // COMPONENTES
        // ============================================

        // Componente de Bot√≥n (HIG compliant)
        function Button({ children, onClick, variant = 'primary', className = '', disabled = false, ariaLabel }) {
            const baseClasses = "min-h-[48px] px-6 py-3 rounded-lg font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2";

            const variants = {
                primary: "bg-blue-500 hover:bg-blue-600 text-white focus:ring-blue-500 disabled:bg-blue-300",
                secondary: "bg-gray-200 hover:bg-gray-300 text-gray-800 focus:ring-gray-500 disabled:bg-gray-100",
                success: "bg-green-500 hover:bg-green-600 text-white focus:ring-green-500 disabled:bg-green-300",
                danger: "bg-red-500 hover:bg-red-600 text-white focus:ring-red-500 disabled:bg-red-300",
                warning: "bg-orange-500 hover:bg-orange-600 text-white focus:ring-orange-500 disabled:bg-orange-300"
            };

            return (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    aria-label={ariaLabel || children}
                    className={`${baseClasses} ${variants[variant]} ${className} disabled:cursor-not-allowed disabled:opacity-60`}
                >
                    {children}
                </button>
            );
        }

        // Componente de Input (HIG compliant)
        function Input({ type = 'text', value, onChange, placeholder, label, step, min, max, className = '' }) {
            const inputId = `input-${label?.replace(/\s/g, '-')}`;

            return (
                <div className="flex flex-col gap-2">
                    {label && (
                        <label htmlFor={inputId} className="text-sm font-medium text-gray-700">
                            {label}
                        </label>
                    )}
                    <input
                        id={inputId}
                        type={type}
                        value={value}
                        onChange={onChange}
                        placeholder={placeholder}
                        step={step}
                        min={min}
                        max={max}
                        className={`min-h-[44px] px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${className}`}
                        aria-label={label || placeholder}
                    />
                </div>
            );
        }

        // Checkbox Toggle (HIG compliant)
        function CheckboxToggle({ checked, onChange, label }) {
            return (
                <button
                    onClick={() => onChange(!checked)}
                    className={`flex items-center gap-2 min-h-[44px] px-4 py-2 rounded-lg transition-all ${
                        checked ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'
                    } hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500`}
                    role="checkbox"
                    aria-checked={checked}
                    aria-label={label}
                >
                    <span className="text-xl">{checked ? '‚úì' : '‚óã'}</span>
                    <span className="text-sm font-medium">{label}</span>
                </button>
            );
        }

        // Bot√≥n de calidad de comida
        function MealQualityButton({ quality, onChange, mealName }) {
            const states = {
                pendiente: { emoji: '‚è∏Ô∏è', text: 'Pendiente', color: 'bg-gray-200 text-gray-600' },
                bueno: { emoji: '‚úÖ', text: 'Saludable', color: 'bg-green-100 text-green-700' },
                regular: { emoji: '‚ö†Ô∏è', text: 'Regular', color: 'bg-yellow-100 text-yellow-700' },
                malo: { emoji: '‚ùå', text: 'Malo', color: 'bg-red-100 text-red-700' }
            };

            const cycleQuality = () => {
                const order = ['pendiente', 'bueno', 'regular', 'malo'];
                const currentIndex = order.indexOf(quality);
                const nextIndex = (currentIndex + 1) % order.length;
                onChange(order[nextIndex]);
            };

            const current = states[quality];

            return (
                <div className="flex flex-col gap-1">
                    <label className="text-sm font-semibold text-gray-700">{mealName}</label>
                    <button
                        onClick={cycleQuality}
                        className={`min-h-[48px] px-4 py-2 rounded-lg font-medium transition-all hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${current.color}`}
                        aria-label={`${mealName}: ${current.text}`}
                    >
                        <span className="text-xl mr-2">{current.emoji}</span>
                        <span>{current.text}</span>
                    </button>
                </div>
            );
        }

        // Contador de agua
        function WaterCounter({ vasos, onChange, goal = 7, dayName }) {
            const percentage = Math.min((vasos / goal) * 100, 100);
            const isComplete = vasos >= goal;

            return (
                <div className="space-y-2">
                    <div className="flex items-center justify-between">
                        <span className="text-sm font-medium text-gray-700">üíß Agua</span>
                        <span className={`text-sm font-bold ${isComplete ? 'text-cyan-600' : 'text-gray-600'}`}>
                            {vasos}/{goal} vasos
                        </span>
                    </div>

                    {/* Barra de progreso */}
                    <div className="w-full bg-gray-200 rounded-full h-2">
                        <div
                            className={`h-2 rounded-full transition-all duration-300 ${isComplete ? 'bg-cyan-500' : 'bg-cyan-300'}`}
                            style={{ width: `${percentage}%` }}
                        />
                    </div>

                    {/* Botones de control */}
                    <div className="flex gap-2">
                        <Button
                            variant="secondary"
                            onClick={() => onChange(Math.max(0, vasos - 1))}
                            className="flex-1 min-h-[44px] text-lg"
                            ariaLabel={`Reducir vasos de agua para ${dayName}`}
                        >
                            -
                        </Button>
                        <Button
                            variant="primary"
                            onClick={() => onChange(Math.min(15, vasos + 1))}
                            className="flex-1 min-h-[44px] text-lg"
                            ariaLabel={`Aumentar vasos de agua para ${dayName}`}
                        >
                            +
                        </Button>
                        <Button
                            variant="secondary"
                            onClick={() => onChange(0)}
                            className="min-h-[44px] px-3"
                            ariaLabel={`Reiniciar contador de agua para ${dayName}`}
                        >
                            Reset
                        </Button>
                    </div>
                </div>
            );
        }

        // Selector de D√≠a (HIG compliant)
        function DaySelector({ selectedDay, onDayChange }) {
            const days = [
                { key: 'lunes', label: 'Lunes', icon: 'üèä' },
                { key: 'martes', label: 'Martes', icon: 'üí™' },
                { key: 'miercoles', label: 'Mi√©rcoles', icon: 'üö∂' },
                { key: 'jueves', label: 'Jueves', icon: 'üèä' },
                { key: 'viernes', label: 'Viernes', icon: 'üí™' },
                { key: 'sabado', label: 'S√°bado', icon: 'üå≥' },
                { key: 'domingo', label: 'Domingo', icon: 'üìÖ' }
            ];

            const currentIndex = days.findIndex(d => d.key === selectedDay);

            const goToPrevDay = () => {
                const newIndex = currentIndex === 0 ? 6 : currentIndex - 1;
                onDayChange(days[newIndex].key);
            };

            const goToNextDay = () => {
                const newIndex = currentIndex === 6 ? 0 : currentIndex + 1;
                onDayChange(days[newIndex].key);
            };

            return (
                <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                    {/* Navegaci√≥n con flechas */}
                    <div className="flex items-center justify-between gap-4 mb-4">
                        <Button
                            variant="secondary"
                            onClick={goToPrevDay}
                            className="min-w-[48px] px-4"
                            ariaLabel="D√≠a anterior"
                        >
                            ‚Üê Anterior
                        </Button>

                        <div className="text-center flex-1">
                            <div className="text-4xl mb-2">{days[currentIndex].icon}</div>
                            <h2 className="text-2xl font-bold text-gray-800">
                                {days[currentIndex].label}
                            </h2>
                        </div>

                        <Button
                            variant="secondary"
                            onClick={goToNextDay}
                            className="min-w-[48px] px-4"
                            ariaLabel="D√≠a siguiente"
                        >
                            Siguiente ‚Üí
                        </Button>
                    </div>

                    {/* Dropdown para selecci√≥n r√°pida */}
                    <div className="mt-4">
                        <label htmlFor="day-select" className="block text-sm font-medium text-gray-700 mb-2">
                            Ir a d√≠a espec√≠fico:
                        </label>
                        <select
                            id="day-select"
                            value={selectedDay}
                            onChange={(e) => onDayChange(e.target.value)}
                            className="w-full min-h-[48px] px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-base"
                            aria-label="Seleccionar d√≠a de la semana"
                        >
                            {days.map(day => (
                                <option key={day.key} value={day.key}>
                                    {day.icon} {day.label}
                                </option>
                            ))}
                        </select>
                    </div>
                </div>
            );
        }

        // Tarjeta de D√≠a
        function DayCard({ dayName, dayData, onChange }) {
            const dayConfig = {
                lunes: { icon: 'üèä', activity: 'Nataci√≥n 5:00 AM', exerciseGoal: 9 },
                martes: { icon: 'üí™', activity: 'Fuerza 5:00 AM', exerciseGoal: 9 },
                miercoles: { icon: 'üö∂', activity: 'Descanso Activo', exerciseGoal: 7 },
                jueves: { icon: 'üèä', activity: 'Nataci√≥n 5:00 AM', exerciseGoal: 9 },
                viernes: { icon: 'üí™', activity: 'Fuerza 5:00 AM', exerciseGoal: 9 },
                sabado: { icon: 'üå≥', activity: 'Fin de Semana', exerciseGoal: 7 },
                domingo: { icon: 'üìÖ', activity: 'Fin de Semana', exerciseGoal: 7 }
            };

            const config = dayConfig[dayName];
            const displayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);

            // Handler para cambios con logging
            const handleChange = (field, value) => {
                console.log(`Updating ${dayName}.${field} to:`, value);
                const newData = { ...dayData, [field]: value };
                console.log('New data:', newData);
                onChange(newData);
            };

            // Calcular progreso del d√≠a
            const calculateProgress = () => {
                let completed = 0;
                let total = 0;

                // Actividades del d√≠a
                const activities = ['pausa1', 'pausa2', 'familia', 'sueno'];
                if (dayData.tipo === 'natacion' || dayData.tipo === 'fuerza') {
                    activities.push('ejercicio');
                }
                if (dayData.tipo === 'descanso') {
                    activities.push('movimiento');
                }
                if (dayData.tipo === 'finDeSemana') {
                    activities.push('aireLibre');
                    if (dayName === 'domingo') {
                        activities.push('mealPrep', 'prep');
                    }
                }

                activities.forEach(act => {
                    total++;
                    if (dayData[act]) completed++;
                });

                // Comidas (3)
                ['desayuno', 'almuerzo', 'cena'].forEach(meal => {
                    total++;
                    if (dayData[meal] !== 'pendiente') completed++;
                });

                // Agua
                total++;
                if (dayData.vasos >= config.exerciseGoal) completed++;

                return Math.round((completed / total) * 100);
            };

            const progress = calculateProgress();

            return (
                <div className="bg-white rounded-lg shadow-md p-4 border border-gray-200">
                    {/* Header del d√≠a - Compacto */}
                    <div className="flex items-center justify-between pb-2 mb-3 border-b border-gray-200">
                        <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span className="text-xl">{config.icon}</span>
                            {displayName}
                        </h3>
                        <div className="text-xl font-bold text-blue-600">{progress}%</div>
                    </div>

                    {/* Actividad principal del d√≠a - PRIMERO */}
                    {(dayData.tipo === 'natacion' || dayData.tipo === 'fuerza') && (
                        <div className="space-y-2">
                            <div className="bg-blue-50 rounded-lg p-2 text-center">
                                <p className="text-sm font-semibold text-blue-800">{config.activity}</p>
                            </div>
                            <CheckboxToggle
                                checked={dayData.ejercicio}
                                onChange={(val) => handleChange('ejercicio', val)}
                                label="üèãÔ∏è Ejercicio completado"
                            />
                        </div>
                    )}

                    {dayData.tipo === 'descanso' && (
                        <div className="space-y-2">
                            <div className="bg-blue-50 rounded-lg p-2 text-center">
                                <p className="text-sm font-semibold text-blue-800">{config.activity}</p>
                            </div>
                            <CheckboxToggle
                                checked={dayData.movimiento}
                                onChange={(val) => handleChange('movimiento', val)}
                                label="üö∂ Movimiento ligero"
                            />
                        </div>
                    )}

                    {dayData.tipo === 'finDeSemana' && (
                        <div className="space-y-2">
                            <div className="bg-blue-50 rounded-lg p-2 text-center">
                                <p className="text-sm font-semibold text-blue-800">{config.activity}</p>
                            </div>
                            <CheckboxToggle
                                checked={dayData.aireLibre}
                                onChange={(val) => handleChange('aireLibre', val)}
                                label="üå≥ Actividad al aire libre"
                            />
                            {dayName === 'domingo' && (
                                <>
                                    <CheckboxToggle
                                        checked={dayData.mealPrep}
                                        onChange={(val) => handleChange('mealPrep', val)}
                                        label="üç± Meal prep"
                                    />
                                    <CheckboxToggle
                                        checked={dayData.prep}
                                        onChange={(val) => handleChange('prep', val)}
                                        label="üìã Prep semanal"
                                    />
                                </>
                            )}
                        </div>
                    )}

                    {/* Pausas */}
                    <div className="space-y-2 pt-3 border-t border-gray-200">
                        <CheckboxToggle
                            checked={dayData.pausa1}
                            onChange={(val) => handleChange('pausa1', val)}
                            label="‚è∞ Pausa 10am"
                        />
                        <CheckboxToggle
                            checked={dayData.pausa2}
                            onChange={(val) => handleChange('pausa2', val)}
                            label="‚è∞ Pausa 3pm"
                        />
                    </div>

                    {/* Alimentaci√≥n */}
                    <div className="space-y-2 pt-3 border-t border-gray-200">
                        <p className="text-sm font-semibold text-gray-700 mb-2">Alimentaci√≥n</p>
                        <div className="space-y-2">
                            <MealQualityButton
                                quality={dayData.desayuno}
                                onChange={(val) => handleChange('desayuno', val)}
                                mealName="Desayuno"
                            />
                            <MealQualityButton
                                quality={dayData.almuerzo}
                                onChange={(val) => handleChange('almuerzo', val)}
                                mealName="Almuerzo"
                            />
                            <MealQualityButton
                                quality={dayData.cena}
                                onChange={(val) => handleChange('cena', val)}
                                mealName="Cena"
                            />
                        </div>
                    </div>

                    {/* Hidrataci√≥n */}
                    <div className="pt-3 border-t border-gray-200">
                        <WaterCounter
                            vasos={dayData.vasos}
                            onChange={(val) => handleChange('vasos', val)}
                            goal={config.exerciseGoal}
                            dayName={displayName}
                        />
                    </div>

                    {/* Bienestar */}
                    <div className="space-y-2 pt-3 border-t border-gray-200">
                        <CheckboxToggle
                            checked={dayData.familia}
                            onChange={(val) => handleChange('familia', val)}
                            label="üë®‚Äçüë©‚Äçüëß Tiempo familiar"
                        />
                        <CheckboxToggle
                            checked={dayData.sueno}
                            onChange={(val) => handleChange('sueno', val)}
                            label="üåô Sue√±o adecuado"
                        />
                    </div>
                </div>
            );
        }

        // Panel de Estad√≠sticas Mensuales
        function MonthlyStatsPanel({ currentWeek, historicalData, userConfig }) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyData = useMemo(() => {
                // Filtrar semanas del mes actual
                const monthWeeks = historicalData.filter(week => {
                    const weekDate = new Date(week.startDate);
                    return weekDate.getMonth() === currentMonth && weekDate.getFullYear() === currentYear;
                });

                if (monthWeeks.length === 0) {
                    return null;
                }

                // Calcular estad√≠sticas
                let totalTrainings = 0;
                let totalQuality = 0;
                let totalWater = 0;
                let totalDays = 0;

                monthWeeks.forEach(week => {
                    ['lunes', 'martes', 'jueves', 'viernes'].forEach(day => {
                        if (week[day].ejercicio) totalTrainings++;
                    });

                    totalQuality += calculateFoodQuality(week);

                    ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'].forEach(day => {
                        totalWater += week[day].vasos;
                        totalDays++;
                    });
                });

                const avgQuality = Math.round(totalQuality / monthWeeks.length);
                const avgWater = Math.round(totalWater / totalDays);

                // Progreso corporal
                const firstWeek = monthWeeks[0];
                const lastWeek = monthWeeks[monthWeeks.length - 1];

                const pesoInicial = parseFloat(firstWeek.peso) || 0;
                const pesoActual = parseFloat(lastWeek.peso) || 0;
                const difPeso = pesoActual - pesoInicial;

                const cinturaInicial = parseFloat(firstWeek.cintura) || 0;
                const cinturaActual = parseFloat(lastWeek.cintura) || 0;
                const difCintura = cinturaActual - cinturaInicial;

                const estatura = parseFloat(lastWeek.estatura || userConfig.estatura) || 0;
                const imcInicial = calculateBMI(pesoInicial, estatura);
                const imcActual = calculateBMI(pesoActual, estatura);
                const difIMC = imcActual - imcInicial;

                return {
                    weekCount: monthWeeks.length,
                    totalTrainings,
                    avgQuality,
                    avgWater,
                    pesoInicial,
                    pesoActual,
                    difPeso,
                    cinturaInicial,
                    cinturaActual,
                    difCintura,
                    imcInicial,
                    imcActual,
                    difIMC
                };
            }, [historicalData, currentMonth, currentYear, userConfig]);

            if (!monthlyData) {
                return (
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">üìà Estad√≠sticas Mensuales</h2>
                        <p className="text-gray-600">No hay datos suficientes. Completa al menos una semana y arch√≠vala para ver estad√≠sticas mensuales.</p>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-xl shadow-lg p-6 space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">üìà Estad√≠sticas Mensuales</h2>

                    {/* Estad√≠sticas generales */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-blue-50 rounded-lg p-4 text-center border border-blue-200">
                            <div className="text-3xl font-bold text-blue-700">{monthlyData.totalTrainings}</div>
                            <div className="text-sm text-blue-600 mt-1">Entrenamientos</div>
                        </div>

                        <div className="bg-green-50 rounded-lg p-4 text-center border border-green-200">
                            <div className="text-3xl font-bold text-green-700">{monthlyData.avgQuality}%</div>
                            <div className="text-sm text-green-600 mt-1">Calidad Promedio</div>
                        </div>

                        <div className="bg-cyan-50 rounded-lg p-4 text-center border border-cyan-200">
                            <div className="text-3xl font-bold text-cyan-700">{monthlyData.avgWater}</div>
                            <div className="text-sm text-cyan-600 mt-1">Vasos/d√≠a Promedio</div>
                        </div>

                        <div className="bg-purple-50 rounded-lg p-4 text-center border border-purple-200">
                            <div className="text-3xl font-bold text-purple-700">{monthlyData.weekCount}</div>
                            <div className="text-sm text-purple-600 mt-1">Semanas Completas</div>
                        </div>
                    </div>

                    {/* Progreso corporal */}
                    <div>
                        <h3 className="text-xl font-semibold text-gray-800 mb-4">üéØ Progreso Corporal</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {/* Peso */}
                            <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                                <div className="text-sm font-semibold text-orange-700 mb-2">Peso</div>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-sm text-gray-600">Inicial</div>
                                        <div className="text-xl font-bold text-gray-800">{monthlyData.pesoInicial.toFixed(1)} kg</div>
                                    </div>
                                    <div className="text-2xl">‚Üí</div>
                                    <div>
                                        <div className="text-sm text-gray-600">Actual</div>
                                        <div className="text-xl font-bold text-gray-800">{monthlyData.pesoActual.toFixed(1)} kg</div>
                                    </div>
                                </div>
                                <div className={`mt-2 text-center text-lg font-bold ${monthlyData.difPeso < 0 ? 'text-green-600' : 'text-orange-600'}`}>
                                    {monthlyData.difPeso > 0 ? '+' : ''}{monthlyData.difPeso.toFixed(1)} kg
                                    {monthlyData.difPeso < 0 && ' üéâ'}
                                </div>
                            </div>

                            {/* Cintura */}
                            <div className="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-4 border border-pink-200">
                                <div className="text-sm font-semibold text-pink-700 mb-2">Cintura</div>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-sm text-gray-600">Inicial</div>
                                        <div className="text-xl font-bold text-gray-800">{monthlyData.cinturaInicial.toFixed(1)} cm</div>
                                    </div>
                                    <div className="text-2xl">‚Üí</div>
                                    <div>
                                        <div className="text-sm text-gray-600">Actual</div>
                                        <div className="text-xl font-bold text-gray-800">{monthlyData.cinturaActual.toFixed(1)} cm</div>
                                    </div>
                                </div>
                                <div className={`mt-2 text-center text-lg font-bold ${monthlyData.difCintura < 0 ? 'text-green-600' : 'text-pink-600'}`}>
                                    {monthlyData.difCintura > 0 ? '+' : ''}{monthlyData.difCintura.toFixed(1)} cm
                                    {monthlyData.difCintura < 0 && ' üéâ'}
                                </div>
                            </div>

                            {/* IMC */}
                            <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border border-indigo-200">
                                <div className="text-sm font-semibold text-indigo-700 mb-2">IMC</div>
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="text-sm text-gray-600">Inicial</div>
                                        <div className="text-xl font-bold text-gray-800">{monthlyData.imcInicial}</div>
                                    </div>
                                    <div className="text-2xl">‚Üí</div>
                                    <div>
                                        <div className="text-sm text-gray-600">Actual</div>
                                        <div className="text-xl font-bold text-gray-800">{monthlyData.imcActual}</div>
                                    </div>
                                </div>
                                <div className={`mt-2 text-center text-lg font-bold ${monthlyData.difIMC < 0 ? 'text-green-600' : 'text-indigo-600'}`}>
                                    {monthlyData.difIMC > 0 ? '+' : ''}{monthlyData.difIMC}
                                    {monthlyData.difIMC < 0 && ' üéâ'}
                                </div>
                                <div className="text-xs text-center text-gray-600 mt-1">
                                    {getBMICategory(monthlyData.imcActual)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Componente de Gr√°fico Simple con Canvas
        function SimpleChart({ type, data, title }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data || data.length === 0) return;

                // Destruir gr√°fico anterior si existe
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');

                chartRef.current = new Chart(ctx, {
                    type: type,
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [type, data]);

            return (
                <div className="bg-gray-50 rounded-lg p-4">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">{title}</h3>
                    <div style={{ position: 'relative', height: '300px' }}>
                        <canvas ref={canvasRef}></canvas>
                    </div>
                </div>
            );
        }

        // Panel de Mediciones
        function MeasurementsPanel({ currentWeek, onUpdateMeasurements, historicalData }) {
            const [peso, setPeso] = useState(currentWeek.peso || '');
            const [cintura, setCintura] = useState(currentWeek.cintura || '');
            const [estatura, setEstatura] = useState(currentWeek.estatura || '');

            // Actualizar states cuando cambia currentWeek
            useEffect(() => {
                setPeso(currentWeek.peso || '');
                setCintura(currentWeek.cintura || '');
                setEstatura(currentWeek.estatura || '');
            }, [currentWeek]);

            const handleSave = () => {
                onUpdateMeasurements('peso', peso);
                onUpdateMeasurements('cintura', cintura);
                onUpdateMeasurements('estatura', estatura);
            };

            // Calcular IMC
            const calculateBMI = () => {
                const pesoNum = parseFloat(peso);
                const estaturaNum = parseFloat(estatura);
                if (pesoNum && estaturaNum && estaturaNum > 0) {
                    const estaturaM = estaturaNum / 100;
                    return (pesoNum / (estaturaM * estaturaM)).toFixed(1);
                }
                return null;
            };

            const getBMICategory = (bmi) => {
                if (!bmi) return '';
                const bmiNum = parseFloat(bmi);
                if (bmiNum < 18.5) return 'Bajo peso';
                if (bmiNum < 25) return 'Normal';
                if (bmiNum < 30) return 'Sobrepeso';
                if (bmiNum < 35) return 'Obesidad I';
                if (bmiNum < 40) return 'Obesidad II';
                return 'Obesidad III';
            };

            const getBMICategoryColor = (bmi) => {
                if (!bmi) return 'text-gray-600';
                const bmiNum = parseFloat(bmi);
                if (bmiNum < 18.5) return 'text-yellow-600';
                if (bmiNum < 25) return 'text-green-600';
                if (bmiNum < 30) return 'text-orange-600';
                return 'text-red-600';
            };

            const bmi = calculateBMI();
            const bmiCategory = getBMICategory(bmi);
            const bmiColor = getBMICategoryColor(bmi);

            // Obtener datos hist√≥ricos (√∫ltimas 12 semanas con mediciones)
            const getHistoricalMeasurements = () => {
                const allWeeks = [...historicalData, currentWeek]
                    .filter(week => week.peso || week.cintura)
                    .slice(-12);
                return allWeeks;
            };

            const historicalMeasurements = getHistoricalMeasurements();

            // Calcular comparaci√≥n con semana anterior
            const getPreviousWeek = () => {
                if (historicalMeasurements.length < 2) return null;
                return historicalMeasurements[historicalMeasurements.length - 2];
            };

            const previousWeek = getPreviousWeek();

            const calculateDifference = (current, previous) => {
                if (!current || !previous) return null;
                const diff = parseFloat(current) - parseFloat(previous);
                return diff.toFixed(1);
            };

            const pesoDiff = previousWeek ? calculateDifference(peso, previousWeek.peso) : null;
            const cinturaDiff = previousWeek ? calculateDifference(cintura, previousWeek.cintura) : null;

            // Preparar datos para gr√°ficos
            const weightChartData = {
                labels: historicalMeasurements.map(week => `S${week.weekNumber}`),
                datasets: [
                    {
                        label: 'Peso (kg)',
                        data: historicalMeasurements.map(week => parseFloat(week.peso) || 0),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Cintura (cm)',
                        data: historicalMeasurements.map(week => parseFloat(week.cintura) || 0),
                        borderColor: 'rgb(249, 115, 22)',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            };

            return (
                <div className="space-y-6 max-w-6xl mx-auto p-4">
                    <h2 className="text-2xl font-bold text-gray-800">üìè Mediciones Corporales</h2>

                    {/* Formulario de entrada */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">
                            Semana {currentWeek.weekNumber} - {currentWeek.year}
                        </h3>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Peso (kg)
                                </label>
                                <input
                                    type="number"
                                    step="0.1"
                                    value={peso}
                                    onChange={(e) => setPeso(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Ej: 75.5"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Cintura (cm)
                                </label>
                                <input
                                    type="number"
                                    step="0.1"
                                    value={cintura}
                                    onChange={(e) => setCintura(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Ej: 85.0"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Altura (cm)
                                </label>
                                <input
                                    type="number"
                                    step="0.1"
                                    value={estatura}
                                    onChange={(e) => setEstatura(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Ej: 175"
                                />
                            </div>
                        </div>

                        <button
                            onClick={handleSave}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            üíæ Guardar Mediciones
                        </button>
                    </div>

                    {/* Estad√≠sticas actuales */}
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">üìä Estad√≠sticas Actuales</h3>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {/* Peso */}
                            <div className="bg-blue-50 rounded-lg p-4">
                                <div className="text-sm font-medium text-gray-600 mb-1">Peso Actual</div>
                                <div className="text-3xl font-bold text-blue-600">
                                    {peso ? `${peso} kg` : '---'}
                                </div>
                                {pesoDiff && (
                                    <div className={`text-sm mt-2 ${parseFloat(pesoDiff) <= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {parseFloat(pesoDiff) > 0 ? '+' : ''}{pesoDiff} kg vs semana anterior
                                        {parseFloat(pesoDiff) <= 0 ? ' üéâ' : ''}
                                    </div>
                                )}
                            </div>

                            {/* Cintura */}
                            <div className="bg-orange-50 rounded-lg p-4">
                                <div className="text-sm font-medium text-gray-600 mb-1">Cintura Actual</div>
                                <div className="text-3xl font-bold text-orange-600">
                                    {cintura ? `${cintura} cm` : '---'}
                                </div>
                                {cinturaDiff && (
                                    <div className={`text-sm mt-2 ${parseFloat(cinturaDiff) <= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                        {parseFloat(cinturaDiff) > 0 ? '+' : ''}{cinturaDiff} cm vs semana anterior
                                        {parseFloat(cinturaDiff) <= 0 ? ' üéâ' : ''}
                                    </div>
                                )}
                            </div>

                            {/* IMC */}
                            <div className="bg-purple-50 rounded-lg p-4">
                                <div className="text-sm font-medium text-gray-600 mb-1">IMC</div>
                                <div className={`text-3xl font-bold ${bmiColor}`}>
                                    {bmi || '---'}
                                </div>
                                {bmiCategory && (
                                    <div className={`text-sm mt-2 font-medium ${bmiColor}`}>
                                        {bmiCategory}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Gr√°fico de evoluci√≥n */}
                    {historicalMeasurements.length > 1 && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">üìà Evoluci√≥n (√öltimas {historicalMeasurements.length} semanas)</h3>
                            <div style={{ position: 'relative', height: '300px' }}>
                                <SimpleChart
                                    type="line"
                                    data={weightChartData}
                                    title=""
                                />
                            </div>
                        </div>
                    )}

                    {/* Historial de mediciones */}
                    {historicalMeasurements.length > 0 && (
                        <div className="bg-white rounded-lg shadow-md p-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">üìã Historial de Mediciones</h3>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Semana</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Peso (kg)</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cintura (cm)</th>
                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IMC</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {historicalMeasurements.reverse().map((week, idx) => {
                                            const weekBMI = week.peso && week.estatura ?
                                                ((parseFloat(week.peso) / Math.pow(parseFloat(week.estatura)/100, 2)).toFixed(1)) :
                                                null;
                                            return (
                                                <tr key={idx} className={idx === 0 ? 'bg-blue-50' : ''}>
                                                    <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                                        S{week.weekNumber} {week.year}
                                                        {idx === 0 && <span className="ml-2 text-blue-600 text-xs">(Actual)</span>}
                                                    </td>
                                                    <td className="px-4 py-3 text-sm text-gray-700">{week.peso || '---'}</td>
                                                    <td className="px-4 py-3 text-sm text-gray-700">{week.cintura || '---'}</td>
                                                    <td className="px-4 py-3 text-sm text-gray-700">{weekBMI || '---'}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Panel de Gr√°ficos
        function ChartsPanel({ currentWeek, historicalData, userConfig }) {
            // Preparar datos para gr√°ficos
            const chartData = useMemo(() => {
                const allWeeks = [...historicalData, currentWeek];
                const last12Weeks = allWeeks.slice(-12);
                const last8Weeks = allWeeks.slice(-8);

                // Datos de peso y cintura
                const weightWaistData = last12Weeks.map(week => ({
                    semana: `S${week.weekNumber}`,
                    peso: parseFloat(week.peso) || null,
                    cintura: parseFloat(week.cintura) || null
                })).filter(d => d.peso !== null || d.cintura !== null);

                // Datos de calidad alimenticia
                const foodQualityData = last8Weeks.map(week => {
                    const quality = calculateFoodQuality(week);
                    let color = '#F97316'; // naranja
                    if (quality >= 85) color = '#10B981'; // verde
                    else if (quality >= 70) color = '#3B82F6'; // azul
                    else if (quality >= 55) color = '#FBBF24'; // amarillo

                    return {
                        semana: `S${week.weekNumber}`,
                        calidad: quality,
                        fill: color
                    };
                });

                // Distribuci√≥n de comidas (semana actual)
                let saludables = 0, regulares = 0, malas = 0;
                ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'].forEach(day => {
                    ['desayuno', 'almuerzo', 'cena'].forEach(meal => {
                        const quality = currentWeek[day][meal];
                        if (quality === 'bueno') saludables++;
                        else if (quality === 'regular') regulares++;
                        else if (quality === 'malo') malas++;
                    });
                });

                const foodDistribution = [
                    { name: 'Saludables', value: saludables, color: '#10B981' },
                    { name: 'Regulares', value: regulares, color: '#FBBF24' },
                    { name: 'Malas', value: malas, color: '#EF4444' }
                ].filter(d => d.value > 0);

                // Hidrataci√≥n semanal
                const hydrationData = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'].map(day => {
                    const goal = ['lunes', 'martes', 'jueves', 'viernes'].includes(day) ? 9 : 7;
                    const vasos = currentWeek[day].vasos;
                    return {
                        dia: day.charAt(0).toUpperCase() + day.slice(1, 3),
                        vasos,
                        meta: goal,
                        color: vasos >= goal ? '#06B6D4' : '#9CA3AF'
                    };
                });

                // IMC a lo largo del tiempo
                const bmiData = last12Weeks.map(week => {
                    const estatura = parseFloat(week.estatura || userConfig.estatura);
                    const peso = parseFloat(week.peso);
                    const bmi = calculateBMI(peso, estatura);
                    return {
                        semana: `S${week.weekNumber}`,
                        imc: bmi ? parseFloat(bmi) : null
                    };
                }).filter(d => d.imc !== null);

                return {
                    weightWaistData,
                    foodQualityData,
                    foodDistribution,
                    hydrationData,
                    bmiData
                };
            }, [currentWeek, historicalData, userConfig]);

            // Preparar datos para Chart.js
            const weightWaistChartData = chartData.weightWaistData.length > 0 ? {
                labels: chartData.weightWaistData.map(d => d.semana),
                datasets: [
                    {
                        label: 'Peso (kg)',
                        data: chartData.weightWaistData.map(d => d.peso),
                        borderColor: '#F97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        yAxisID: 'y',
                    },
                    {
                        label: 'Cintura (cm)',
                        data: chartData.weightWaistData.map(d => d.cintura),
                        borderColor: '#EC4899',
                        backgroundColor: 'rgba(236, 72, 153, 0.1)',
                        yAxisID: 'y1',
                    }
                ]
            } : null;

            const foodQualityChartData = chartData.foodQualityData.length > 0 ? {
                labels: chartData.foodQualityData.map(d => d.semana),
                datasets: [{
                    label: 'Calidad (%)',
                    data: chartData.foodQualityData.map(d => d.calidad),
                    backgroundColor: chartData.foodQualityData.map(d => d.fill),
                }]
            } : null;

            const foodDistributionChartData = chartData.foodDistribution.length > 0 ? {
                labels: chartData.foodDistribution.map(d => d.name),
                datasets: [{
                    data: chartData.foodDistribution.map(d => d.value),
                    backgroundColor: chartData.foodDistribution.map(d => d.color),
                }]
            } : null;

            const hydrationChartData = {
                labels: chartData.hydrationData.map(d => d.dia),
                datasets: [
                    {
                        label: 'Vasos consumidos',
                        data: chartData.hydrationData.map(d => d.vasos),
                        backgroundColor: chartData.hydrationData.map(d => d.color),
                    },
                    {
                        label: 'Meta',
                        data: chartData.hydrationData.map(d => d.meta),
                        backgroundColor: '#E5E7EB',
                    }
                ]
            };

            const bmiChartData = chartData.bmiData.length > 0 ? {
                labels: chartData.bmiData.map(d => d.semana),
                datasets: [{
                    label: 'IMC',
                    data: chartData.bmiData.map(d => d.imc),
                    borderColor: '#6366F1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 3,
                    tension: 0.4
                }]
            } : null;

            return (
                <div className="bg-white rounded-xl shadow-lg p-6 space-y-8">
                    <h2 className="text-2xl font-bold text-gray-800">üìä Gr√°ficos de Progreso</h2>

                    {historicalData.length === 0 && (
                        <div className="text-center py-8 text-gray-600">
                            <p>Completa y archiva algunas semanas para ver tus gr√°ficos de progreso.</p>
                        </div>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Gr√°fico 1: Peso y Cintura */}
                        {weightWaistChartData && (
                            <SimpleChart
                                type="line"
                                data={weightWaistChartData}
                                title="Evoluci√≥n de Peso y Cintura"
                            />
                        )}

                        {/* Gr√°fico 2: Calidad Alimenticia */}
                        {foodQualityChartData && (
                            <SimpleChart
                                type="bar"
                                data={foodQualityChartData}
                                title="√çndice de Calidad Alimenticia"
                            />
                        )}

                        {/* Gr√°fico 3: Distribuci√≥n de Comidas */}
                        {foodDistributionChartData && (
                            <SimpleChart
                                type="doughnut"
                                data={foodDistributionChartData}
                                title="Distribuci√≥n Semanal de Comidas"
                            />
                        )}

                        {/* Gr√°fico 4: Hidrataci√≥n Semanal */}
                        <SimpleChart
                            type="bar"
                            data={hydrationChartData}
                            title="Hidrataci√≥n Semanal"
                        />

                        {/* Gr√°fico 5: IMC */}
                        {bmiChartData && (
                            <div className="lg:col-span-2">
                                <SimpleChart
                                    type="line"
                                    data={bmiChartData}
                                    title="Evoluci√≥n del IMC"
                                />
                                <div className="mt-4 flex justify-center gap-6 text-sm">
                                    <div className="flex items-center gap-2">
                                        <div className="w-4 h-4 bg-green-500 rounded"></div>
                                        <span>Normal (18.5-24.9)</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-4 h-4 bg-yellow-500 rounded"></div>
                                        <span>Sobrepeso (25-29.9)</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-4 h-4 bg-orange-500 rounded"></div>
                                        <span>Obesidad (30+)</span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============================================
        // AUTHENTICATION COMPONENT
        // ============================================

        function AuthForm({ onAuthSuccess }) {
            const [loading, setLoading] = useState(false);
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    if (isLogin) {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email,
                            password
                        });
                        if (error) throw error;
                        onAuthSuccess(data.user);
                    } else {
                        const { data, error } = await supabase.auth.signUp({
                            email,
                            password
                        });
                        if (error) throw error;
                        alert('¬°Registro exitoso! Por favor inicia sesi√≥n.');
                        setIsLogin(true);
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-xl p-8 max-w-md w-full">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2 text-center">
                            ‚ú® Wellness Dashboard
                        </h1>
                        <p className="text-gray-600 text-center mb-6">
                            {isLogin ? 'Inicia sesi√≥n para continuar' : 'Crea tu cuenta'}
                        </p>

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Email
                                </label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="tu@email.com"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Contrase√±a
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    minLength={6}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="M√≠nimo 6 caracteres"
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors disabled:opacity-50"
                            >
                                {loading ? 'Procesando...' : (isLogin ? 'Iniciar Sesi√≥n' : 'Registrarse')}
                            </button>
                        </form>

                        <div className="mt-4 text-center">
                            <button
                                onClick={() => setIsLogin(!isLogin)}
                                className="text-blue-600 hover:text-blue-700 text-sm font-medium"
                            >
                                {isLogin ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Inicia sesi√≥n'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============================================
        // COMPONENTE PRINCIPAL
        // ============================================

        function App() {
            // Estado de autenticaci√≥n
            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);

            // Verificar autenticaci√≥n al montar
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    setAuthLoading(false);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                });

                return () => subscription.unsubscribe();
            }, []);

            // Datos del usuario (usar Supabase si est√° autenticado)
            const [currentWeek, setCurrentWeek, weekLoading] = useSupabase('wellness_currentWeek', getInitialWeekData(), user?.id);
            const [historicalData, setHistoricalData, historyLoading] = useSupabase('wellness_historical', [], user?.id);
            const [userConfig, setUserConfig, configLoading] = useSupabase('wellness_config', { estatura: '', nombre: '' }, user?.id);

            // Obtener d√≠a actual de la semana
            const getCurrentDayName = () => {
                const days = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
                return days[new Date().getDay()];
            };

            // Sistema de navegaci√≥n de p√°ginas (MUST be declared before any returns)
            const [currentPage, setCurrentPage] = useState('home');
            const [selectedDay, setSelectedDay] = useState(getCurrentDayName());

            // Calcular estad√≠sticas semanales (useMemo MUST be before returns)
            const weeklyStats = useMemo(() => {
                if (!currentWeek) return { foodQuality: 0, trainings: 0, totalWater: 0, bmi: null, bmiCategory: '', historicalCount: 0 };

                const foodQuality = calculateFoodQuality(currentWeek);

                let trainings = 0;
                ['lunes', 'martes', 'jueves', 'viernes'].forEach(day => {
                    if (currentWeek[day]?.ejercicio) trainings++;
                });

                let totalWater = 0;
                ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'].forEach(day => {
                    totalWater += currentWeek[day]?.vasos || 0;
                });

                const bmi = calculateBMI(parseFloat(currentWeek.peso), parseFloat(currentWeek.estatura || userConfig.estatura));

                return {
                    foodQuality,
                    trainings,
                    totalWater,
                    bmi,
                    bmiCategory: getBMICategory(bmi),
                    historicalCount: historicalData?.length || 0
                };
            }, [currentWeek, historicalData, userConfig]);

            // Logout function
            const handleLogout = async () => {
                await supabase.auth.signOut();
                setUser(null);
            };

            // Mostrar pantalla de carga mientras verifica autenticaci√≥n
            if (authLoading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-4xl mb-4">‚è≥</div>
                            <div className="text-gray-600">Cargando...</div>
                        </div>
                    </div>
                );
            }

            // Mostrar login si no est√° autenticado
            if (!user) {
                return <AuthForm onAuthSuccess={setUser} />;
            }

            // Mostrar pantalla de carga mientras carga datos
            if (weekLoading || historyLoading || configLoading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-4xl mb-4">üìä</div>
                            <div className="text-gray-600">Cargando tus datos...</div>
                        </div>
                    </div>
                );
            }

            // Actualizar d√≠a espec√≠fico
            const updateDay = (dayName, newData) => {
                setCurrentWeek(prev => ({
                    ...prev,
                    [dayName]: newData
                }));
            };

            // Actualizar mediciones
            const updateMeasurements = (field, value) => {
                setCurrentWeek(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const foodQualityMsg = getFoodQualityMessage(weeklyStats.foodQuality);

            // Nueva semana
            const startNewWeek = () => {
                if (!confirm('¬øDeseas archivar la semana actual e iniciar una nueva?')) return;

                const weekToArchive = {
                    ...currentWeek,
                    archivedDate: new Date().toISOString()
                };

                setHistoricalData(prev => [...prev, weekToArchive]);
                setCurrentWeek(getInitialWeekData());
                alert('Semana archivada exitosamente. ¬°Comienza una nueva semana!');
            };

            // Exportar CSV
            const exportCSV = () => {
                const allWeeks = [...historicalData, currentWeek];
                const rows = [];

                // Header
                rows.push('Semana,A√±o,Fecha Inicio,Peso (kg),Cintura (cm),IMC,D√≠a,Tipo D√≠a,Ejercicio,Pausa 10am,Pausa 3pm,Familia,Sue√±o,Desayuno,Almuerzo,Cena,Vasos Agua,√çndice Calidad');

                allWeeks.forEach(week => {
                    const weekQuality = calculateFoodQuality(week);
                    const bmi = calculateBMI(parseFloat(week.peso), parseFloat(week.estatura || userConfig.estatura));

                    ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'].forEach(day => {
                        const d = week[day];
                        rows.push([
                            week.weekNumber,
                            week.year,
                            new Date(week.startDate).toLocaleDateString(),
                            week.peso || '',
                            week.cintura || '',
                            bmi || '',
                            day,
                            d.tipo,
                            d.ejercicio ? 'S√≠' : 'No',
                            d.pausa1 ? 'S√≠' : 'No',
                            d.pausa2 ? 'S√≠' : 'No',
                            d.familia ? 'S√≠' : 'No',
                            d.sueno ? 'S√≠' : 'No',
                            d.desayuno,
                            d.almuerzo,
                            d.cena,
                            d.vasos,
                            weekQuality
                        ].join(','));
                    });
                });

                const csvContent = rows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `wellness_data_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                alert('CSV exportado exitosamente');
            };

            // Backup JSON
            const backupJSON = () => {
                const backup = {
                    exportDate: new Date().toISOString(),
                    currentWeek,
                    historicalData,
                    userConfig
                };

                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `wellness_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                alert('Backup JSON creado exitosamente');
            };

            // Importar JSON
            const importJSON = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (!data.currentWeek || !data.historicalData) {
                            throw new Error('Formato JSON inv√°lido');
                        }

                        if (!confirm('¬øDeseas importar estos datos? Los datos actuales ser√°n reemplazados.')) return;

                        setCurrentWeek(data.currentWeek);
                        setHistoricalData(data.historicalData);
                        if (data.userConfig) setUserConfig(data.userConfig);
                        alert('Datos importados exitosamente');
                    } catch (error) {
                        alert('Error al importar: ' + error.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            // Renderizar p√°ginas seg√∫n navegaci√≥n
            const renderPage = () => {
                switch(currentPage) {
                    case 'measurements':
                        return (
                            <MeasurementsPanel
                                currentWeek={currentWeek}
                                onUpdateMeasurements={updateMeasurements}
                                historicalData={historicalData}
                            />
                        );

                    case 'stats':
                        return (
                            <div className="max-w-7xl mx-auto px-4 py-6">
                                <MonthlyStatsPanel
                                    currentWeek={currentWeek}
                                    historicalData={historicalData}
                                    userConfig={userConfig}
                                />
                            </div>
                        );

                    case 'charts':
                        return (
                            <div className="max-w-7xl mx-auto px-4 py-6">
                                <ChartsPanel
                                    currentWeek={currentWeek}
                                    historicalData={historicalData}
                                    userConfig={userConfig}
                                />
                            </div>
                        );

                    case 'home':
                    default:
                        return (
                            <main className="max-w-3xl mx-auto px-4 py-6">
                                {/* Selector de D√≠a */}
                                <DaySelector
                                    selectedDay={selectedDay}
                                    onDayChange={setSelectedDay}
                                />

                                {/* Tarjeta del D√≠a Seleccionado */}
                                <DayCard
                                    key={selectedDay}
                                    dayName={selectedDay}
                                    dayData={currentWeek[selectedDay]}
                                    onChange={(newData) => updateDay(selectedDay, newData)}
                                />
                            </main>
                        );
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header Simple */}
                    <header className="bg-white shadow-md">
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    {currentPage !== 'home' && (
                                        <Button
                                            variant="secondary"
                                            onClick={() => setCurrentPage('home')}
                                            ariaLabel="Ir a inicio"
                                        >
                                            üè† Home
                                        </Button>
                                    )}
                                    <div>
                                        <h1 className="text-4xl font-bold text-gray-800">‚ú® Estilo de vida</h1>
                                        <p className="text-sm text-gray-600">
                                            Semana {currentWeek.weekNumber}
                                            {user && <span className="ml-3 text-blue-600">‚Ä¢ {user.email}</span>}
                                        </p>
                                    </div>
                                    {user && (
                                        <button
                                            onClick={handleLogout}
                                            className="text-sm text-gray-600 hover:text-gray-800 underline"
                                        >
                                            Cerrar Sesi√≥n
                                        </button>
                                    )}
                                </div>

                                {/* Navegaci√≥n Principal */}
                                <div className="flex gap-3 flex-wrap">
                                    <Button
                                        variant={currentPage === 'home' ? 'primary' : 'secondary'}
                                        onClick={() => setCurrentPage('home')}
                                    >
                                        üìÖ D√≠a
                                    </Button>
                                    <Button
                                        variant={currentPage === 'measurements' ? 'primary' : 'secondary'}
                                        onClick={() => setCurrentPage('measurements')}
                                    >
                                        üìè Mediciones
                                    </Button>
                                    <Button
                                        variant={currentPage === 'stats' ? 'primary' : 'secondary'}
                                        onClick={() => setCurrentPage('stats')}
                                    >
                                        üìà Estad√≠sticas
                                    </Button>
                                    <Button
                                        variant={currentPage === 'charts' ? 'primary' : 'secondary'}
                                        onClick={() => setCurrentPage('charts')}
                                    >
                                        üìä Gr√°ficos
                                    </Button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Contenido de la p√°gina actual */}
                    {renderPage()}

                    {/* Footer */}
                    <footer className="bg-gray-800 text-white mt-12 py-8">
                        <div className="max-w-7xl mx-auto px-4 text-center space-y-4">
                            <h3 className="text-xl font-bold">üìã Instrucciones de Uso</h3>
                            <div className="grid md:grid-cols-3 gap-6 text-sm text-left">
                                <div>
                                    <h4 className="font-semibold text-blue-300 mb-2">Lunes por la ma√±ana</h4>
                                    <ul className="space-y-1 text-gray-300">
                                        <li>‚Ä¢ Pesarse en ayunas</li>
                                        <li>‚Ä¢ Medir cintura</li>
                                        <li>‚Ä¢ Ingresar valores</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 className="font-semibold text-green-300 mb-2">Durante la semana</h4>
                                    <ul className="space-y-1 text-gray-300">
                                        <li>‚Ä¢ Marcar actividades diarias</li>
                                        <li>‚Ä¢ Calificar comidas</li>
                                        <li>‚Ä¢ Registrar vasos de agua</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 className="font-semibold text-purple-300 mb-2">Fin de semana</h4>
                                    <ul className="space-y-1 text-gray-300">
                                        <li>‚Ä¢ Revisar progreso</li>
                                        <li>‚Ä¢ Exportar datos (mensual)</li>
                                        <li>‚Ä¢ Iniciar nueva semana (domingo noche)</li>
                                    </ul>
                                </div>
                            </div>
                            <p className="text-gray-400 text-xs pt-4">
                                Dashboard de Bienestar Personal ‚Ä¢ Datos almacenados localmente
                            </p>
                        </div>
                    </footer>
                </div>
            );
        }

        // Renderizar la app (React 18)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
